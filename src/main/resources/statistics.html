<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Server Statistics</title>
    <link href="/styles.css" rel="stylesheet" type="text/css" />
    <link href="/analysis.css" rel="stylesheet" type="text/css" /> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spoqa-han-sans@3.3.0/css/SpoqaHanSansNeo.min.css" />

    <style>
        /* í†µê³„ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
        .filter-bar {
            background: var(--glass-bg);
            padding: 16px;
            border-radius: var(--rounded);
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }

        select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .import-btn {
            margin-left: auto;
            background: var(--dps);
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .rank-row {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: 0.2s;
        }
        .rank-row:hover { background: rgba(255,255,255,0.08); }
        .rank-row.active { border-left: 3px solid var(--dps); background: rgba(41, 255, 111, 0.1); }

        .bar-container { flex: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin: 0 12px; position: relative; }
        .bar-fill { height: 100%; background: var(--dps); border-radius: 4px; }
        .bar-fill.max { background: rgba(255, 255, 255, 0.5); position: absolute; top:0; left:0; height: 100%; z-index: -1; } /* ìµœê³ ì  í‘œì‹œìš© */

    </style>
</head>

<body>
<div class="analysis-container">

    <div class="sidebar" style="flex: 0 0 400px;">
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 12px;">ğŸ† ì§ì—…ë³„ DPS ìˆœìœ„</div>
        <div id="rankingList" style="flex: 1; overflow-y: auto;">
        </div>
    </div>

    <div class="main-content">

        <div class="filter-bar">
            <select id="monthSelect" onchange="loadRanking()"></select>
            <select id="bossSelect" onchange="loadRanking()"></select>
            <button class="import-btn" onclick="triggerImport()">DB ì—…ë°ì´íŠ¸ (Admin)</button>
        </div>

        <div class="stat-grid" id="jobStatCard" style="display:none;">
            <div class="stat-card">
                <div class="stat-label">ì„ íƒëœ ì§ì—…</div>
                <div class="stat-value white" id="selJobName">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">í‘œë³¸ ìˆ˜ (ë¡œê·¸)</div>
                <div class="stat-value" id="selJobCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">í‰ê·  DPS</div>
                <div class="stat-value" id="selJobAvg">-</div>
            </div>
        </div>

        <div class="skill-section" style="margin-top: 20px; display:none;" id="skillSection">
            <div class="section-title">ìŠ¤í‚¬ íš¨ìœ¨ ë¶„ì„ (í‰ê·  ë°ë¯¸ì§€)</div>
            <div class="skill-header-custom">
                <div class="cell name" style="flex: 0 0 200px;">ìŠ¤í‚¬ëª…</div>
                <div class="cell dmg" style="flex: 1;">í‰ê·  ë°ë¯¸ì§€</div>
                <div class="cell right" style="width: 80px; text-align: right;">ì‹œì „ìˆ˜</div>
            </div>
            <div class="skill-list-container detailsSkills">
                <div class="skills" id="skillList"></div>
            </div>
        </div>

        <div id="emptyMsg" class="empty-state">
            ì¢Œì¸¡ì—ì„œ ì§ì—…ì„ ì„ íƒí•˜ë©´ ìƒì„¸ ìŠ¤í‚¬ ë¶„ì„ì´ í‘œì‹œë©ë‹ˆë‹¤.
        </div>

    </div>
</div>

<script>
    const formatNum = (num) => new Intl.NumberFormat().format(num);

    // 1. ì´ˆê¸°í™”: í•„í„° ë¡œë“œ
    async function init() {
        try {
            const res = await fetch('/api/stats/filters');
            const data = await res.json();

            // ì›” ì„ íƒ
            const monthSel = document.getElementById('monthSelect');
            data.months.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                monthSel.appendChild(opt);
            });

            // ë³´ìŠ¤ ì„ íƒ
            const bossSel = document.getElementById('bossSelect');
            data.bosses.forEach(b => {
                const opt = document.createElement('option');

                // [ìˆ˜ì •] valueì— ê³ ìœ  ID(3200_101)ë¥¼ ë„£ìŠµë‹ˆë‹¤.
                // í™”ë©´ì—ëŠ” ì´ë¦„(ë¶„ë…¸í•œ í¬ë¡œë©”ë°)ì„ í‘œì‹œí•©ë‹ˆë‹¤.
                opt.value = b.id;
                opt.innerText = b.name;

                bossSel.appendChild(opt);
            });

            // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì²« ë¡œë”©
            if(data.months.length > 0 && data.bosses.length > 0) {
                loadRanking();
            }
        } catch(e) { console.error(e); }
    }

    // 2. ë­í‚¹ ë¡œë“œ
    async function loadRanking() {
        const month = document.getElementById('monthSelect').value;
        const bossId = document.getElementById('bossSelect').value; // [ë³€ìˆ˜ëª… ë³€ê²½] boss -> bossId

        // UI ì´ˆê¸°í™”
        document.getElementById('rankingList').innerHTML = '<div style="padding:20px;">ë¡œë”©ì¤‘...</div>';
        document.getElementById('jobStatCard').style.display = 'none';
        document.getElementById('skillSection').style.display = 'none';
        document.getElementById('emptyMsg').style.display = 'block';

        // [ìˆ˜ì •] íŒŒë¼ë¯¸í„° bossIdë¡œ ì „ì†¡
        const res = await fetch(`/api/stats/ranking?month=${month}&boss=${encodeURIComponent(bossId)}`);
        const list = await res.json();

        const rankEl = document.getElementById('rankingList');
        rankEl.innerHTML = '';

        if(list.length === 0) {
            rankEl.innerHTML = '<div style="padding:20px; opacity:0.5;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        // ê·¸ë˜í”„ ìŠ¤ì¼€ì¼ìš© ìµœëŒ€ê°’
        const globalMax = Math.max(...list.map(i => i.maxDps));

        list.forEach((item, idx) => {
            const row = document.createElement('div');
            row.className = 'rank-row';

            const avgPct = globalMax > 0 ? (item.avgDps / globalMax) * 100 : 0;
            const maxPct = globalMax > 0 ? (item.maxDps / globalMax) * 100 : 0;

            row.innerHTML = `
                <div style="font-weight:bold; width: 30px;">#${idx+1}</div>
                <div style="width: 80px;">${item.job}</div>
                <div class="bar-container">
                    <div class="bar-fill max" style="width: ${maxPct}%" title="ìµœê³ ì : ${formatNum(item.maxDps)}"></div>
                    <div class="bar-fill" style="width: ${avgPct}%"></div>
                </div>
                <div style="width: 80px; text-align:right; font-weight:bold; color:var(--dps);">${formatNum(item.avgDps)}</div>
            `;

            row.onclick = () => {
                document.querySelectorAll('.rank-row').forEach(r => r.classList.remove('active'));
                row.classList.add('active');
                loadJobDetails(item);
            };

            rankEl.appendChild(row);
        });
    }

    // 3. ì§ì—… ìƒì„¸ ë¡œë“œ
    async function loadJobDetails(jobItem) {
        document.getElementById('emptyMsg').style.display = 'none';
        document.getElementById('jobStatCard').style.display = 'grid';
        document.getElementById('skillSection').style.display = 'flex';

        // ì¹´ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('selJobName').innerText = jobItem.job;
        document.getElementById('selJobCount').innerText = jobItem.count + " records";
        document.getElementById('selJobAvg').innerText = formatNum(jobItem.avgDps);

        // ìŠ¤í‚¬ ë°ì´í„° ë¡œë“œ
        const month = document.getElementById('monthSelect').value;
        const bossId = document.getElementById('bossSelect').value; // [ë³€ìˆ˜ëª… ë³€ê²½]

        // [ìˆ˜ì •] íŒŒë¼ë¯¸í„° bossIdë¡œ ì „ì†¡
        const res = await fetch(`/api/stats/skills?month=${month}&boss=${encodeURIComponent(bossId)}&job=${encodeURIComponent(jobItem.job)}`);
        const skills = await res.json();

        const skillEl = document.getElementById('skillList');
        skillEl.innerHTML = '';

        const maxDmg = skills.length > 0 ? Math.max(...skills.map(s => s.avgDamage)) : 0;

        skills.forEach(s => {
            const row = document.createElement('div');
            row.className = 'skillRow';
            const pct = maxDmg > 0 ? (s.avgDamage / maxDmg) * 100 : 0;

            row.innerHTML = `
                <div class="cell name" style="flex: 0 0 200px;">${s.name}</div>
                <div class="cell dmg" style="flex: 1;">
                    <div class="dmgFill" style="width: ${pct}%;"></div>
                    <div class="dmgText">${formatNum(s.avgDamage)}</div>
                </div>
                <div class="cell right" style="width: 80px; color:white; justify-content:flex-end;">
                    ${s.avgCount.toFixed(1)}íšŒ
                </div>
            `;
            skillEl.appendChild(row);
        });
    }

    // 4. Admin Import íŠ¸ë¦¬ê±°
    async function triggerImport() {
        if(!confirm("logs í´ë”ì˜ ëª¨ë“  íŒŒì¼ì„ DBë¡œ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)")) return;

        try {
            const btn = document.querySelector('.import-btn');
            btn.innerText = "ì²˜ë¦¬ì¤‘...";
            btn.disabled = true;

            const res = await fetch('/api/admin/import', { method: 'POST' });
            const data = await res.json();

            alert(data.message);
            location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì„œ í•„í„° ê°±ì‹ 
        } catch(e) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + e);
            document.querySelector('.import-btn').innerText = "DB ì—…ë°ì´íŠ¸ (Admin)";
            document.querySelector('.import-btn').disabled = false;
        }
    }

    init();
</script>
</body>
</html>